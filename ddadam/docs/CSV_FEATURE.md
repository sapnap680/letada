# 📊 CSVアップロード機能ガイド

このドキュメントでは、新しく追加されたCSVアップロード機能について説明します。

---

## 🎯 概要

元のStreamlitアプリで提供されていたCSVアップロード機能が、Next.js + FastAPI構成でも利用できるようになりました。

### 主な機能

- ✅ CSVファイルのアップロード
- ✅ 選手データのJBA照合
- ✅ 色分けされた照合結果Excelファイルの生成
- ✅ リアルタイム進捗表示
- ✅ 並列処理による高速化

---

## 📁 CSVファイルの形式

### 必須列

- **氏名**: 選手の氏名
- **生年月日**: YYYY-MM-DD形式推奨
- **その他**: 氏名カナ、学年など

### サンプルCSV

```csv
氏名,氏名カナ,生年月日,学年
田中 太郎,タナカ タロウ,2003-04-15,2年
佐藤 次郎,サトウ ジロウ,2002-08-22,3年
鈴木 花子,スズキ ハナコ,2004-01-10,1年
```

### 対応エンコーディング

- UTF-8
- Shift_JIS
- CP932
- UTF-8-SIG

---

## 🚀 使い方

### 1. フロントエンド（ブラウザ）

1. **トップページにアクセス**
   ```
   https://your-project.vercel.app
   ```

2. **CSVモードに切り替え**
   - 「📊 CSVアップロードモード」ボタンをクリック

3. **CSVファイルを選択**
   - ローカルのCSVファイルを選択
   - ファイル名から大学名が自動推測される

4. **大学名を入力（オプション）**
   - 省略した場合、ファイル名から自動取得

5. **アップロード**
   - 「CSVをアップロードして照合開始」をクリック

6. **進捗確認**
   - 自動的に進捗画面に遷移
   - 2秒ごとに自動更新

7. **ダウンロード**
   - 処理完了後、Excelファイルをダウンロード

### 2. API（プログラム）

```bash
# CSVファイルをアップロード
curl -X POST \
  https://your-railway-url.up.railway.app/csv/upload \
  -F "file=@players.csv" \
  -F "university_name=白鴎大学"

# レスポンス
{
  "status": "queued",
  "job_id": "abc-123-def",
  "message": "CSVファイルの処理を開始しました（30行）",
  "polling_url": "/jobs/abc-123-def"
}

# ジョブステータス確認
curl https://your-railway-url.up.railway.app/jobs/abc-123-def

# レスポンス
{
  "job_id": "abc-123-def",
  "status": "done",
  "progress": 1.0,
  "message": "処理が完了しました",
  "output_path": "outputs/白鴎大学_verified_abc123.xlsx"
}

# Excelファイルをダウンロード
curl -O https://your-railway-url.up.railway.app/csv/download/白鴎大学_verified_abc123.xlsx
```

---

## 📊 出力されるExcelファイル

### 色分けルール

| 結果 | 背景色 | 説明 |
|------|--------|------|
| ✅ **完全一致** | 緑 | JBAに登録済み、情報が一致 |
| ⚠️ **類似あり** | 黄 | 類似した選手が見つかった |
| ❌ **不一致** | 赤 | JBAに登録が見つからない |

### 追加される列

- **照合結果**: ✅ / ⚠️ / ❌
- **JBA登録状況**: 詳細メッセージ
- **類似度スコア**: 0.0 ~ 1.0

---

## 🔧 技術仕様

### バックエンド

- **エンドポイント**: `/csv/upload`
- **メソッド**: POST
- **Content-Type**: multipart/form-data
- **パラメータ**:
  - `file`: CSVファイル（required）
  - `university_name`: 大学名（optional）

### 処理フロー

```
1. CSVアップロード
   ↓
2. エンコーディング自動検出
   ↓
3. DataFrameに変換
   ↓
4. JBAログイン
   ↓
5. 大学データ事前ロード（Phase 1）
   ↓
6. 並列処理で選手照合（Phase 2）
   ↓
7. 永続キャッシュ保存（Phase 3）
   ↓
8. 色分けExcel生成
   ↓
9. ファイル保存
   ↓
10. ジョブ完了通知
```

### パフォーマンス

| 項目 | 値 |
|------|---|
| 並列スレッド数 | 5（デフォルト） |
| 処理速度 | 約100行/分 |
| キャッシュヒット時 | 約1000行/分 |

---

## 🐛 トラブルシューティング

### エラー 1: CSVの読み込み失敗

```
CSVファイルの読み込みに失敗しました
```

**原因:**
- エンコーディングが対応していない
- CSVフォーマットが正しくない

**解決方法:**
1. UTF-8で保存し直す
2. カンマ区切りになっているか確認
3. 文字化けがないか確認

### エラー 2: ファイルサイズが大きすぎる

**推奨:**
- 10MB以下
- 1000行以下

**大きなファイルの場合:**
1. ファイルを分割
2. 複数回に分けてアップロード

### エラー 3: 大学名が取得できない

**解決方法:**
1. ファイル名に大学名を含める（例: `白鴎大学.csv`）
2. または手動で大学名を入力

---

## 📚 関連ファイル

### バックエンド

- `backend/routers/csv_upload.py` - APIエンドポイント
- `backend/worker/jba_verification_lib.py` - CSV処理ロジック
- `backend/main.py` - ルーター登録

### フロントエンド

- `frontend/pages/csv.tsx` - CSVアップロードページ
- `frontend/pages/index.tsx` - モード切り替え
- `frontend/pages/result.tsx` - 進捗・結果表示

---

## 🔄 元のStreamlit機能との互換性

| 機能 | Streamlit版 | Next.js版 |
|------|------------|----------|
| CSVアップロード | ✅ | ✅ |
| エンコーディング自動検出 | ✅ | ✅ |
| JBA照合 | ✅ | ✅ |
| 色分けExcel生成 | ✅ | ✅ |
| 進捗表示 | ✅ | ✅（2秒ポーリング） |
| リアルタイム更新 | ✅ | ✅ |
| 並列処理 | ✅ | ✅ |
| 永続キャッシュ | ✅ | ✅ |

**すべての機能が移行されました！** ✅

---

## 🚀 今後の改善予定

- [ ] ドラッグ&ドロップ対応
- [ ] 複数CSVファイルの一括アップロード
- [ ] アップロード履歴の表示
- [ ] CSVプレビュー機能
- [ ] カラムマッピング機能

---

**CSV機能が完全に復活しました！** 🎉

何か質問があれば、[GitHub Issues](https://github.com/YOUR_USERNAME/jba-system/issues) で質問してください。

