# CSV自動訂正システム

JBAデータベースと照合してCSVファイルを自動訂正するシステムです。

## 機能

- JBAデータベースとの照合
- CSVファイルの自動訂正
- 生年月日の不一致を自動修正
- **身長・体重・ポジション・出身校・学年情報の自動取得**
- **異常値検出機能（身長・体重・出身校の妥当性チェック）**
- 詳細な照合結果レポート

## 使用方法

### 1. システム起動

```bash
streamlit run csv_verification_system.py
```

### 2. JBAログイン

- サイドバーでJBAのメールアドレスとパスワードを入力
- 「JBAにログイン」ボタンをクリック

### 3. CSVファイル処理

1. **CSVファイルをアップロード**
   - 選手名と生年月日が含まれるCSVファイルをアップロード
   - サポートするカラム名：
     - 名前: `名前`, `氏名`, `選手名`, `name`, `Name`
     - 生年月日: `生年月日`, `誕生日`, `birth_date`, `Birth Date`

2. **大学名を入力**
   - サイドバーで大学名を入力（例: 白鴎大学）

3. **詳細情報取得オプション**
   - 「詳細情報を取得」にチェックを入れると、身長・体重・ポジション・出身校・学年情報も取得
   - 処理時間が長くなりますが、より詳細な情報が得られます

4. **自動訂正を実行**
   - 「自動訂正を実行」ボタンをクリック
   - システムがJBAデータベースと照合して訂正版を作成

### 4. 結果確認・ダウンロード

- **統計情報**: 完全一致、訂正件数、未発見件数、異常値検出件数
- **詳細結果**: タブで分かれた結果表示
  - 完全一致: JBAデータベースと完全に一致したデータ
  - 訂正済み: 生年月日などを訂正したデータ
  - 未発見: JBAデータベースに見つからなかったデータ
  - **異常値検出**: 身長・体重・出身校に異常値が検出されたデータ
- **訂正版CSVダウンロード**: 訂正されたCSVファイルをダウンロード

## CSVファイル形式

### 推奨形式

```csv
選手名,カナ名,学部,学年,身長,体重,ポジション,出身校,背番号,生年月日
田中太郎,タナカタロウ,法学部,3年,180,75,PG,○○高校,10,2000/5/15
佐藤花子,サトウハナコ,経済学部,2年,165,60,SG,△△高校,88,1999/3/22
```

### 取得可能な詳細情報

- **身長**: JBAデータベースから自動取得（cm単位）
- **体重**: JBAデータベースから自動取得（kg単位）
- **ポジション**: JBAデータベースから自動取得（PG、SG、SF、PF、C等）
- **出身校**: JBAデータベースから自動取得
- **学年**: JBAデータベースから自動取得
- **背番号**: JBAデータベースから自動取得

### サポートする日付形式

- `2000/5/15`
- `2000年5月15日`
- `2000-05-15`

## 照合ロジック

1. **名前の類似度計算**
   - 正規化（全角・半角統一、記号除去）
   - 類似度閾値: 0.8（調整可能）

2. **生年月日の照合**
   - JBA形式（2004年5月31日）に対応
   - 正規化して比較

3. **訂正ルール**
   - 名前が一致し、生年月日が異なる場合 → 生年月日をJBAデータに訂正
   - 完全一致の場合 → 詳細情報があれば追加
   - 照合できない場合 → 未発見として報告

4. **詳細情報取得**
   - 選手詳細ページから身長・体重・ポジション・出身校・学年を自動取得
   - 複数のパターンで情報を検索（テーブル形式、正規表現）
   - 取得できない場合は警告を表示

5. **AI異常値検出（体重・出身校のみ）**
   - **体重**: Google Gemini APIによる高度な検証
     - Gemini 1.5 FlashレベルのAI判断による体重検証
     - バスケットボール選手としての妥当性を評価
     - 極端な値や不自然な精度を検出
   - **出身校**: Google Gemini APIによる高度な検証・訂正
     - Gemini 1.5 FlashレベルのAI判断による学校名検証
     - 漢字ミスや略称の正式名称化を自動実行
     - 留学生の学校名も適切に処理
     - 有名な高校・大学・予備校の知識を活用
   - **身長**: 基本的に記載されているため検証対象外

## 設定オプション

- **類似度閾値**: 0.1〜1.0（デフォルト: 0.8）
- **大学名**: 照合対象の大学名
- **詳細情報取得**: 身長・体重・ポジション等の詳細情報を取得するかどうか
- **Gemini APIキー**: Google Gemini APIを使用した高度なAI検証のAPIキー
- **AI検証**: Gemini APIを使用した高度なAI検証の有効/無効

## 注意事項

- JBAデータベースへのアクセスには有効なアカウントが必要
- 男子チームのみが対象
- 現在年度のデータのみ照合
- 大量のデータ処理には時間がかかる場合があります
- **詳細情報取得時は処理時間が大幅に増加します**

## トラブルシューティング

### ログインエラー
- JBAのメールアドレスとパスワードを確認
- インターネット接続を確認

### 照合結果が少ない
- 大学名の表記を確認（正式名称で入力）
- 類似度閾値を下げる（0.6〜0.7）

### CSVファイルが読み込めない
- 文字エンコーディングを確認（UTF-8推奨）
- カラム名を確認（名前、生年月日が必須）


