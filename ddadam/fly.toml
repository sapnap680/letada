# Fly.io 設定ファイル
# Web Service + Worker Service の両方を実行

app = "jba-verification"  # アプリ名（変更してください）
primary_region = "nrt"  # 東京リージョン

[build]
  dockerfile = "backend/Dockerfile"
  build_args = []

[env]
  PORT = "8000"
  PYTHONUNBUFFERED = "1"

# Web Service（FastAPI）
[[services]]
  processes = ["web"]  # web プロセスのみをサービスとして公開
  internal_port = 8000
  protocol = "tcp"
  auto_stop_machines = false  # 無料プランでもスリープなし
  auto_start_machines = true
  min_machines_running = 0  # 無料プラン用（0にするとスリープするが、リクエストで自動起動）
  max_machines_running = 1

  [[services.ports]]
    handlers = ["http"]
    port = 80
    force_https = true

  [[services.ports]]
    handlers = ["tls", "http"]
    port = 443

  [services.concurrency]
    type = "requests"
    hard_limit = 25
    soft_limit = 20

  [[services.http_checks]]
    interval = "10s"
    timeout = "2s"
    grace_period = "5s"
    method = "GET"
    path = "/health"
    protocol = "http"

# Worker Service（バックグラウンドジョブ処理）
# Fly.ioでは複数プロセスを設定する場合、別のマシンとして起動する
[processes]
  web = "cd /app && uvicorn main:app --host 0.0.0.0 --port 8000"
  worker = "cd /app && python -m worker.worker_runner"

# Worker プロセスの設定
[processes.worker]
  auto_stop_machines = false  # 無料プランでもスリープなし
  auto_start_machines = true
  min_machines_running = 0  # 無料プラン用（ジョブがない時はスリープ）
  max_machines_running = 1

